# HUB HOSPITALARIO - GU√çA COMPLETA DE MIGRACI√ìN BACKEND
## Actualizaci√≥n de Perfil de Usuario con Nuevos Campos

---

## üéØ **RESUMEN DE LA MIGRACI√ìN**

Se han agregado los siguientes campos al formulario de perfil y backend:
- **DNI** (obligatorio) - 7-8 d√≠gitos num√©ricos
- **Tel√©fono** (opcional) - formato argentino
- **Matr√≠cula Profesional** (opcional) - para m√©dicos
- **Especialidad M√©dica** (opcional) - lista predefinida
- **Departamento** (opcional)
- **Cargo** (opcional) - lista predefinida

---

## üìã **PASOS PARA APLICAR LA MIGRACI√ìN EN POCKETBASE**

### **Paso 1: Acceder a PocketBase Admin UI**
1. Ir a: https://pocketbase.manta.com.ar/_/
2. Iniciar sesi√≥n como administrador
3. Navegar a **Collections** ‚Üí **auth_users**

### **Paso 2: Agregar Nuevos Campos**

#### **2.1 Campo DNI (Obligatorio)**
- **Tipo**: Text
- **Nombre**: DNI
- **Requerido**: S√≠ ‚úÖ
- **Validaci√≥n personalizada**: `regex("^[0-9]{7,8}$")`
- **Mensaje de error**: "El DNI debe contener entre 7 y 8 d√≠gitos num√©ricos"
- **Valor por defecto**: `""` (cadena vac√≠a)

#### **2.2 Campo Tel√©fono (Opcional)**
- **Tipo**: Text
- **Nombre**: Tel√©fono
- **Requerido**: No
- **Validaci√≥n personalizada**: `regex("^[+]?[0-9\\s\\-\\(\\)]{10,}$")`
- **Mensaje de error**: "Formato de tel√©fono inv√°lido"
- **Valor por defecto**: `""` (cadena vac√≠a)

#### **2.3 Campo Matr√≠cula Profesional (Opcional)**
- **Tipo**: Text
- **Nombre**: Matr√≠cula Profesional
- **Requerido**: No
- **Validaci√≥n personalizada**: `regex("^[A-Z0-9\\-]{5,20}$")`
- **Mensaje de error**: "Formato de matr√≠cula inv√°lido"
- **Valor por defecto**: `""` (cadena vac√≠a)

#### **2.4 Campo Especialidad M√©dica (Opcional)**
- **Tipo**: Select
- **Nombre**: Especialidad M√©dica
- **Requerido**: No
- **Opciones**:
  ```
  Medicina General
  Cardiolog√≠a
  Neurolog√≠a
  Pediatr√≠a
  Ginecolog√≠a
  Traumatolog√≠a
  Medicina Interna
  Medicina de Urgencias
  Anestesiolog√≠a
  Radiolog√≠a
  Laboratorio
  Farmacia
  Enfermer√≠a
  T√©cnico en Radiolog√≠a
  T√©cnico en Laboratorio
  Administraci√≥n Hospitalaria
  Servicios Generales
  Otro
  ```

#### **2.5 Campo Departamento (Opcional)**
- **Tipo**: Text
- **Nombre**: Departamento
- **Requerido**: No
- **Validaci√≥n personalizada**: `regex("^[A-Za-z√°√©√≠√≥√∫√±√ë\\s]{2,50}$")`
- **Mensaje de error**: "El departamento debe tener entre 2 y 50 caracteres"
- **Valor por defecto**: `""` (cadena vac√≠a)

#### **2.6 Campo Cargo (Opcional)**
- **Tipo**: Select
- **Nombre**: Cargo
- **Requerido**: No
- **Opciones**:
  ```
  Jefe de Servicio
  M√©dico Senior
  M√©dico Residente
  Enfermero/a
  T√©cnico
  Administrativo
  Servicios Generales
  Otro
  ```

### **Paso 3: Configurar API Rules**

En la colecci√≥n `auth_users`, configurar las siguientes reglas de API:

#### **List/Search Rule:**
```
@request.auth.id != ""
```

#### **View Rule:**
```
@request.auth.id = @collection.id
```

#### **Create Rule:**
```
@request.auth.id != ""
```

#### **Update Rule:**
```
@request.auth.id = @collection.id || @request.auth.role.name = "superadmin" || @request.auth.role.name = "admin"
```

#### **Delete Rule:**
```
@request.auth.role.name = "superadmin" || @request.auth.role.name = "admin"
```

### **Paso 4: Verificar Configuraci√≥n**

1. **Probar creaci√≥n de usuario** con todos los campos
2. **Verificar validaciones** funcionan correctamente
3. **Confirmar permisos** de usuario y admin
4. **Testear API endpoints** con Postman o similar

---

## üîß **ENDPOINTS DE API CREADOS**

### **GET /api/auth/profile**
Obtiene el perfil completo del usuario autenticado.

**Respuesta:**
```json
{
  "success": true,
  "user": {
    "id": "user_id",
    "email": "user@hospital.com",
    "firstName": "Juan",
    "lastName": "P√©rez",
    "dni": "12345678",
    "phone": "+54 351 123 4567",
    "professional_id": "MP-12345",
    "specialty": "Cardiolog√≠a",
    "department": "Cardiolog√≠a",
    "position": "M√©dico Senior",
    "verified": true,
    "created": "2025-11-11T10:00:00Z",
    "updated": "2025-11-11T21:30:00Z"
  }
}
```

### **POST /api/auth/update-profile**
Actualiza el perfil del usuario con validaciones completas.

**Par√°metros del body:**
```json
{
  "firstName": "Juan",
  "lastName": "P√©rez",
  "email": "user@hospital.com",
  "dni": "12345678",
  "phone": "+54 351 123 4567",
  "professional_id": "MP-12345",
  "specialty": "Cardiolog√≠a",
  "department": "Cardiolog√≠a",
  "position": "M√©dico Senior",
  "currentPassword": "password123", // Opcional
  "newPassword": "newpassword123",  // Opcional
  "confirmPassword": "newpassword123" // Opcional
}
```

**Validaciones implementadas:**
- DNI obligatorio (7-8 d√≠gitos)
- Email obligatorio y v√°lido
- Contrase√±a actual requerida para cambio
- Confirma contrase√±a debe coincidir
- Tel√©fono opcional pero validado si se proporciona

---

## üß™ **TESTING DE LA MIGRACI√ìN**

### **Test 1: Crear Usuario Nuevo**
```bash
curl -X POST https://pocketbase.manta.com.ar/api/collections/auth_users/records \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@hospital.com",
    "password": "test123",
    "passwordConfirm": "test123",
    "firstName": "Test",
    "lastName": "User",
    "dni": "12345678",
    "phone": "+54 351 123 4567"
  }'
```

### **Test 2: Actualizar Usuario Existente**
```bash
curl -X PATCH https://pocketbase.manta.com.ar/api/collections/auth_users/records/{user_id} \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "+54 351 987 6543",
    "specialty": "Cardiolog√≠a",
    "department": "Cardiolog√≠a"
  }'
```

### **Test 3: Frontend Profile Page**
1. Ir a `/profile`
2. Hacer clic en "Editar Perfil"
3. Completar todos los campos
4. Verificar que se guardan correctamente
5. Probar cambio de contrase√±a

---

## ‚ö†Ô∏è **PROBLEMAS COMUNES Y SOLUCIONES**

### **Error 400: Field 'dni' is required**
- **Causa**: Campo DNI no agregado a la colecci√≥n
- **Soluci√≥n**: Agregar campo DNI como se describe en Paso 2.1

### **Error 403: Cannot access user profile**
- **Causa**: API Rules no configuradas correctamente
- **Soluci√≥n**: Verificar que las reglas del Paso 3 est√©n aplicadas

### **Error de validaci√≥n de formato**
- **Causa**: Regex patterns no configurados en los campos
- **Soluci√≥n**: Agregar las validaciones personalizadas correspondientes

### **Usuario no puede ver sus datos**
- **Causa**: View Rule restrictiva
- **Soluci√≥n**: Configurar `@request.auth.id = @collection.id` en View Rule

---

## üîÑ **ROLLBACK (Si es necesario)**

Si algo sale mal, seguir estos pasos:

1. **Backup de datos**:
```bash
curl -X GET "https://pocketbase.manta.com.ar/api/collections/auth_users/records" > backup_auth_users.json
```

2. **Eliminar campos problem√°ticos**:
   - Ir a PocketBase Admin UI
   - Collections ‚Üí auth_users
   - Eliminar cada campo agregado manualmente

3. **Restaurar backup** si es necesario:
```bash
curl -X POST "https://pocketbase.manta.com.ar/api/collections/auth_users/records" \
  -H "Content-Type: application/json" \
  -d @backup_auth_users.json
```

---

## ‚úÖ **CHECKLIST DE MIGRACI√ìN**

- [ ] Acceso a PocketBase Admin UI confirmado
- [ ] Campo DNI agregado con validaci√≥n
- [ ] Campo Tel√©fono agregado con validaci√≥n
- [ ] Campos profesionales agregados (matr√≠cula, especialidad, etc.)
- [ ] API Rules configuradas correctamente
- [ ] Test de creaci√≥n de usuario exitoso
- [ ] Test de actualizaci√≥n de perfil exitoso
- [ ] Test de frontend (p√°gina /profile) exitoso
- [ ] Documentaci√≥n de endpoints actualizada
- [ ] Training del equipo completado

---

## üìû **SOPORTE**

Para dudas sobre la migraci√≥n:
1. Verificar logs de PocketBase en Admin UI
2. Revisar consola del navegador en el frontend
3. Validar que todos los campos est√©n correctamente configurados
4. Confirmar que los permisos de API sean los correctos

**Estado**: ‚úÖ Migraci√≥n lista para aplicar
**Fecha**: 2025-11-11 21:30:00
**Versi√≥n**: 1.0